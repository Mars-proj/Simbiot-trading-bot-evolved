# Карта улучшений Simbiot-trading-bot

## Цель
Создать самообучающуюся, саморазвивающуюся систему "рентген рынка", масштабируемую до 1000+ пользователей, с гибкими и динамическими порогами. Система должна асинхронно обрабатывать максимальное количество символов и задач без конфликтов, быть гибкой и динамичной.

## Общие улучшения
1. **Асинхронность**:
   - Переписать все модули, работающие с внешними API (MEXC, CoinGecko), на `asyncio` и `aiohttp`.
   - Использовать `aiojobs` для управления пулом задач, чтобы избежать конфликтов при обработке 1000+ пользователей.
2. **Масштабируемость**:
   - Добавить пул подключений к биржам в `exchange_pool.py` (ограничить количество одновременных подключений до 10).
   - Использовать Redis для кэширования всех данных (OHLCV, метаданные символов, балансы, результаты анализа).
   - Разделить задачи на микросервисы (отдельные сервисы для фильтрации, торговли, анализа) для распределения нагрузки.
3. **Самообучение и саморазвитие**:
   - Интегрировать ML-модели во все ключевые модули (`market_rentgen_core.py`, `signal_generator_*.py`, `risk_manager.py`).
   - Добавить автоматическое переобучение моделей на основе новых данных (`retraining_manager.py`).
   - Использовать генетические алгоритмы для оптимизации параметров (порогов, стратегий).
4. **Гибкость и динамичность**:
   - Добавить конфигурационные файлы для всех параметров (пороги, стратегии, лимиты).
   - Позволить пользователям настраивать параметры через API (`api_server.py`).
5. **Мониторинг и логирование**:
   - Улучшить логирование: добавить ротацию логов с помощью `logging.handlers.RotatingFileHandler`.
   - Отправлять критические ошибки в систему мониторинга (через Telegram, когда добавим бота).
   - Добавить метрики с помощью `prometheus` для мониторинга производительности.
6. **Обработка проблемных символов** (Добавлено 2025-04-07):
   - Пропускать проблемные символы, которые вызывают ошибки (например, `TimeoutError`) при запросах к API MEXC.
   - Кэшировать доступные и проблемные символы в Redis с TTL 24 часа для уменьшения нагрузки на API.
   - Обновлять кэш раз в 24 часа, чтобы учитывать изменения в доступности символов.

## Улучшения по модулям

### Управление ядром и запуском
- **`core.py`**:
  1. Вынести API-ключи в `.env` файл для повышения безопасности (Выполнено 2025-04-07).
  2. Создать модуль `user_manager.py` для управления пользователями через Redis или PostgreSQL, чтобы масштабировать систему до 1000+ пользователей (Выполнено 2025-04-07).
  3. Добавить обработку ошибок для `filter_symbols` и `start_trading_all` (Выполнено 2025-04-07).
  4. Добавить обработку дефолтного состояния рынка, если `analyze_market_state` не может получить данные (Выполнено 2025-04-07).
- **`worker.py`**:
  1. Переписать с использованием `asyncio` для асинхронной обработки задач.
  2. Добавить пул воркеров с помощью `aiojobs` для параллельной обработки задач.

### Работа с данными
- **`historical_data_fetcher.py`**:
  1. Исправить обработку данных с CoinGecko (ошибка `string indices must be integers, not 'str'` для символа `AIMMTUSDT`).
  2. Добавить кэширование OHLCV-данных в Redis с ключом `ohlcv:<symbol>:<timeframe>:<since>` и TTL 24 часа.
  3. Добавить троттлинг запросов с помощью `aiohttp` для соблюдения лимитов API MEXC и CoinGecko.
- **`ohlcv_fetcher.py`**:
  1. Объединить с `historical_data_fetcher.py`, если функционал дублируется.
  2. Добавить поддержку нескольких источников данных (Binance, Bybit) через конфигурацию.
- **`data_collector.py`**:
  1. Убедиться, что сбор данных выполняется асинхронно с помощью `asyncio` и `aiohttp`.
  2. Кэшировать данные в Redis для избежания лишних запросов.
- **`data_utils.py`**:
  1. Оптимизировать обработку данных с помощью `pandas` или `numpy`.
  2. Добавить логирование для отладки.
- **`symbol_data_fetcher.py`**:
  1. Кэшировать метаданные символов в Redis с TTL 7 дней.
  2. Убедиться, что запросы выполняются асинхронно.
- **`json_handler.py`**:
  1. Заменить JSON на Redis или PostgreSQL для больших данных.
  2. Добавить компрессию с помощью `gzip`, если JSON-файлы всё же нужны.

### Анализ рынка
- **`market_analyzer.py`**:
  1. Переписать анализ с использованием `asyncio`.
  2. Кэшировать результаты анализа в Redis.
- **`market_rentgen_core.py`**:
  1. Добавить самообучение с помощью ML-моделей из `ml_predictor.py` для выявления аномалий.
  2. Убедиться, что анализ масштабируется для 1000+ пользователей.
- **`market_state_analyzer.py`**:
  1. Добавить динамические пороги для определения состояния рынка (на основе волатильности).
  2. Кэшировать результаты анализа.
  3. Добавить обработку проблемных символов с использованием кэшированных данных из Redis (Выполнено 2025-04-07).
  4. Добавить проверку сетевого доступа перед запросами к API (Выполнено 2025-04-07).
  5. Использовать альтернативные символы (например, `ETH/USDT`, `BNB/USDT`), если основной символ недоступен (Выполнено 2025-04-07).
- **`market_trend_checker.py`**:
  1. Интегрировать с `ml_predictor.py` для прогнозирования трендов.
  2. Убедиться, что проверка трендов выполняется асинхронно.
- **`ohlcv_analyzer.py`**:
  1. Добавить самообучение с помощью ML для выявления паттернов.
  2. Оптимизировать анализ с помощью `pandas`.
- **`token_analyzer.py`**:
  1. Добавить динамические метрики для оценки токенов.
  2. Кэшировать результаты анализа.
- **`token_potential_evaluator.py`**:
  1. Интегрировать с `ml_predictor.py` для оценки потенциала.
  2. Убедиться, что оценка масштабируется для тысяч токенов.
- **`trade_analyzer.py`**:
  1. Добавить метрики (Sharpe Ratio, максимальная просадка).
  2. Убедиться, что анализ выполняется асинхронно.

### Генерация сигналов
- **`signal_generator_core.py`**:
  1. Добавить самообучение на основе исторических данных.
  2. Позволить пользователям настраивать правила через конфигурацию.
- **`signal_generator_dynamic.py`**:
  1. Добавить динамические пороги для сигналов (на основе волатильности).
  2. Убедиться, что генерация масштабируется для 1000+ пользователей.
- **`signal_generator_indicators.py`**:
  1. Интегрировать с ML для оптимизации параметров индикаторов.
  2. Кэшировать результаты расчётов индикаторов.
- **`signal_blacklist.py`**:
  1. Добавить автоматическое обновление чёрного списка с помощью ML.
  2. Хранить чёрный список в Redis.

### Торговля
- **`start_trading_all.py`**:
  1. Добавить динамическую сумму ордера на основе минимального объёма транзакции (через `symbol_data_fetcher.py`) (Выполнено 2025-04-07).
  2. Добавить проверку баланса перед размещением ордера (Выполнено 2025-04-07).
- **`bot_trading.py`**:
  1. Убедиться, что торговля выполняется асинхронно для 1000+ пользователей.
  2. Позволить задавать разные стратегии через конфигурацию.
- **`trade_executor_core.py`**:
  1. Использовать `aiojobs` для управления пулом торговых задач.
  2. Добавить троттлинг для соблюдения лимитов API MEXC.
- **`trade_executor_signals.py`**:
  1. Добавить приоритизацию сигналов для 1000+ пользователей.
  2. Убедиться, что исполнение масштабируется.
- **`trade_pool_core.py`**, **`trade_pool_manager.py`**, **`trade_pool_queries.py`**:
  1. Использовать `asyncio` для управления пулом.
  2. Убедиться, что пул масштабируется для тысяч сделок.
- **`trading_cycle.py`**:
  1. Добавить возможность настраивать циклы через конфигурацию.
  2. Убедиться, что циклы выполняются асинхронно.
- **`trading_manager.py`**:
  1. Добавить пул воркеров для управления торговлей 1000+ пользователей.
  2. Улучшить логирование для отладки.
- **`order_utils.py`**:
  1. Оптимизировать утилиты для больших объёмов ордеров.
  2. Использовать `asyncio` для асинхронной обработки.

### Управление рисками и позициями
- **`risk_manager.py`**:
  1. Добавить динамические пороги риска (на основе волатильности).
  2. Интегрировать ML для автоматической корректировки параметров.
- **`position_monitor.py`**:
  1. Убедиться, что мониторинг выполняется асинхронно.
  2. Добавить уведомления через `notification_manager.py` при достижении критических уровней.
- **`exit_points_calculator.py`**:
  1. Добавить динамические точки выхода на основе рыночных условий.
  2. Использовать `ml_predictor.py` для прогнозирования точек выхода.
- **`partial_close_calculator.py`**:
  1. Позволить настраивать параметры частичного закрытия через конфигурацию.
  2. Убедиться, что расчёты выполняются асинхронно.
- **`balance_manager.py`**:
  1. Убедиться, что запросы баланса выполняются асинхронно.
  2. Кэшировать баланс в Redis.
- **`deposit_manager.py`**, **`deposit_calculator.py`**:
  1. Добавить адаптивные расчёты депозитов на основе рыночных условий.
  2. Убедиться, что расчёты масштабируются для 1000+ пользователей.

### Машинное обучение
- **`ml_data_preparer.py`**, **`ml_data_preparer_utils.py`**:
  1. Оптимизировать подготовку данных с помощью `pandas` и `numpy`.
  2. Кэшировать подготовленные данные в Redis.
- **`ml_model_trainer.py`**:
  1. Добавить автоматическое переобучение на основе новых данных.
  2. Убедиться, что обучение выполняется в фоновом режиме.
- **`ml_predictor.py`**:
  1. Интегрировать предсказания в `signal_generator_*.py` и `market_rentgen_core.py`.
  2. Убедиться, что предсказания выполняются параллельно для тысяч символов.
- **`model_utils.py`**:
  1. Оптимизировать утилиты для работы с большими моделями.
  2. Добавить логирование для отладки.
- **`retraining_manager.py`**, **`test_retraining_manager.py`**:
  1. Добавить автоматическое переобучение на основе метрик качества.
  2. Убедиться, что `test_retraining_manager.py` покрывает все сценарии.

### Индикаторы и стратегии
- **`indicators.py`**:
  1. Использовать `ta-lib` или `pandas-ta` для эффективного расчёта индикаторов.
  2. Кэшировать результаты расчётов.
- **`strategies.py`**:
  1. Позволить пользователям добавлять свои стратегии через конфигурацию.
  2. Интегрировать ML для автоматической оптимизации стратегий.
- **`features.py`**:
  1. Добавить адаптивные признаки на основе рыночных условий.
  2. Кэшировать признаки в Redis.

### Работа с биржей
- **`exchange_pool.py`**:
  1. Создать пул подключений к MEXC (ограничить до 10 одновременных подключений) (Выполнено 2025-04-07).
  2. Добавить поддержку нескольких бирж (Binance, Bybit) через конфигурацию.
  3. Добавить повторные попытки и задержки для обработки временных проблем с API (Выполнено 2025-04-07).
- **`exchange_factory.py`**:
  1. Добавить поддержку нескольких бирж через конфигурацию.
  2. Убедиться, что фабрика учитывает лимиты API.
- **`exchange_utils.py`**:
  1. Убедиться, что утилиты используют `asyncio`.
  2. Кэшировать результаты запросов к бирже.

### Фильтрация символов
- **`symbol_filter.py`**:
  1. Заменить фиксированный порог фильтрации (`len(result) >= 89`) на динамический (Выполнено 2025-04-07).
  2. Кэшировать результаты фильтрации в Redis (Выполнено 2025-04-07).
  3. Увеличить размер батча до 50 символов и добавить пул задач с помощью `aiojobs`.
  4. Добавить кэширование доступных и проблемных символов в Redis с TTL 24 часа (Выполнено 2025-04-07).
- **`symbol_handler.py`**, **`symbol_trade_processor.py`**:
  1. Убедиться, что обработка выполняется асинхронно.
  2. Кэшировать данные символов в Redis.
- **`test_symbols.py`**:
  1. Добавить автоматические тесты для проверки фильтрации.
  2. Настроить GitHub Actions для запуска тестов.

### Кэширование и хранение данных
- **`cache_manager.py`**, **`cache_utils.py`**:
  1. Убедиться, что кэш работает с Redis и имеет разумные TTL.
  2. Убедиться, что кэш масштабируется для 1000+ пользователей.
- **`redis_client.py`**:
  1. Добавить пул соединений с помощью `aioredis`.
  2. Добавить мониторинг использования Redis.

### Логирование и уведомления
- **`logging_setup.py`**:
  1. Добавить ротацию логов с помощью `logging.handlers.RotatingFileHandler`.
  2. Отправлять критические ошибки в систему мониторинга (через Telegram, позже).
- **`notification_manager.py`**:
  1. Подготовить поддержку отправки уведомлений через Telegram (добавим позже).
  2. Убедиться, что уведомления отправляются асинхронно.

### API и монетизация
- **`api_server.py`**:
  1. Использовать `FastAPI` для создания масштабируемого API-сервера.
  2. Добавить аутентификацию через JWT.
- **`local_model_api.py`**:
  1. Убедиться, что API может обрабатывать запросы от 1000+ пользователей.
  2. Кэшировать результаты запросов к моделям.
- **`monetization.py`**:
  1. Добавить поддержку разных моделей монетизации (подписка, разовые платежи).
  2. Убедиться, что модуль масштабируется для 1000+ пользователей.

### Тестирование и бэктестинг
- **`backtest_cycle.py`**, **`backtest_manager.py`**:
  1. Убедиться, что бэктестинг выполняется асинхронно.
  2. Оптимизировать бэктестинг с помощью `pandas`.
- **`check_all_trades.py`**:
  1. Добавить автоматическую проверку торгов через CI/CD.
  2. Улучшить логирование для отладки.
- **`load_test.py`**:
  1. Убрать из `.gitignore` и добавить в репозиторий.
  2. Использовать `locust` для нагрузочного тестирования с 1000+ пользователями.

### Утилиты
- **`utils.py`**:
  1. Оптимизировать утилиты для больших объёмов данных.
  2. Добавить логирование для отладки.
- **`global_objects.py`**:
  1. Избегать глобальных объектов, использовать инъекцию зависимостей.
- **`limits.py`**:
  1. Добавить адаптивные лимиты на основе рыночных условий.
  2. Убедиться, что лимиты масштабируются для 1000+ пользователей.
- **`config_keys.py`**:
  1. Перенести все ключи в `.env` файл (Выполнено 2025-04-07).
  2. Позволить настраивать ключи через API.
- **`bot_user_data.py`**:
  1. Перенести данные пользователей в Redis или PostgreSQL (Выполнено 2025-04-07).
  2. Добавить шифрование для защиты данных.
